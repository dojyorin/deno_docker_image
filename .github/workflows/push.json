{
    "name": "push",
    "on": {
        "schedule": [{
            "cron": "0 6 * * *"
        }]
    },
    "jobs": {
        "fetch": {
            "name": "fetch: deno latest version",
            "runs-on": "ubuntu-latest",
            "outputs": {
                "deno_v": "${{steps.deno_v.outputs.value}}"
            },
            "steps": [{
                "id": "deno_v",
                "name": "get deno latest version",
                "run": "echo value=$(curl -Ls https://api.github.com/repos/denoland/deno/releases/latest | yq '.tag_name') >> ${{github.output}}"
            }, {
                "name": "compare dockerhub tag and deno latest version",
                "run": "! curl -Ls https://registry.hub.docker.com/v2/repositories/dojyorin/deno/tags?page_size=100 | yq '\"v\" + .results[].name' | grep -q ${{steps.deno_v.outputs.value}}"
            }]
        },
        "build": {
            "name": "build: ${{matrix.distro}}",
            "runs-on": "ubuntu-latest",
            "needs": "fetch",
            "strategy": {
                "fail-fast": true,
                "matrix": {
                    "distro": [
                        "alpine",
                        "distroless"
                    ]
                }
            },
            "env": {
                "tag_f": "dojyorin/deno:${{matrix.distro}}-${{needs.fetch.outputs.deno_v}}",
                "tag_d": "dojyorin/deno:${{matrix.distro}}",
                "tag_v": "dojyorin/deno:${{needs.fetch.outputs.deno_v}}",
                "tag_l": "dojyorin/deno:latest"
            },
            "steps": [{
                "name": "clone repository",
                "uses": "actions/checkout@v3"
            }, {
                "name": "install docker-qemu",
                "uses": "docker/setup-qemu-action@v3"
            }, {
                "name": "login dockerhub",
                "uses": "docker/login-action@v3",
                "with": {
                    "username": "${{github.repository_owner}}",
                    "password": "${{secrets.DOCKERHUB_KEY}}"
                }
            }, {
                "name": "build image",
                "uses": "docker/build-push-action@v5",
                "with": {
                    "push": true,
                    "pull": true,
                    "no-cache": true,
                    "tags": "${{env.tag_f}},${{env.tag_d}}${{matrix.distro == 'distroless' && format(',{0},{1}', env.tag_v, env.tag_l) || ''}}",
                    "platforms": "linux/amd64",
                    "context": "{{defaultContext}}:./src",
                    "file": "${{matrix.distro}}.dockerfile",
                    "build-args": "DENO_VERSION=${{needs.fetch.outputs.deno_v}}"
                }
            }]
        }
    }
}
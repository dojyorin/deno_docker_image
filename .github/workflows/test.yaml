name: test
on:
    push:
        branches-ignore:
            - master
        paths-ignore:
            - .git*
            - '**.md'
    pull_request:
        branches:
            - master
        paths-ignore:
            - .git*
            - '**.md'
jobs:
    fetch:
        name: 'fetch: deno latest version'
        runs-on: ubuntu-latest
        steps:
            - name: set deno latest version to output
              run: echo DENO_VERSION=$(curl -Ls https://api.github.com/repos/denoland/deno/releases/latest | yq '.tag_name') >> ${{github.output}}
            - name: set deno latest version to output
              run: echo ${{jobs.fetch.outputs.DENO_VERSION}}
    test:
        name: 'test: ${{matrix.distro}}'
        runs-on: ubuntu-latest
        needs: fetch
        strategy:
            fail-fast: true
            matrix:
                distro:
                    - alpine
                    - distroless
        env:
            tag_l: ${{github.repository_owner}}/deno:latest
        steps:
            - name: clone repository
              uses: actions/checkout@v3
            - name: install docker-qemu
              uses: docker/setup-qemu-action@v3
            - name: build image
              uses: docker/build-push-action@v5
              with:
                pull: true
                no-cache: true
                tags: ${{env.tag_l}}
                platforms: linux/amd64
                context: '{{defaultContext}}:./src'
                file: ${{matrix.distro}}.dockerfile
                build-args: DENO_VERSION=${{jobs.fetch.outputs.DENO_VERSION}}
            - name: test image
              run: docker run --init --rm ${{env.tag_l}} eval -p 'new Date()'